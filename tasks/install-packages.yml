---
- name: fedora stuff
  block:
    - name: Enable COPR repositories
      community.general.copr:
        name: "{{ item }}"
        state: enabled
      loop:
        - atim/lazygit
        - agriffis/neovim-nightly

    - name: Enable RPM Fusion, Free and Non-Free [Fedora]
      ansible.builtin.dnf:
        name: "https://mirrors.rpmfusion.org/{{ item }}/fedora/rpmfusion-{{ item }}-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present
        disable_gpg_check: true
      with_items:
        - free
        - nonfree

    - name: Update multimedia groups after enabling RPMFusion [Fedora]
      ansible.builtin.shell: >
        dnf groupupdate core -y &&
        dnf groupupdate multimedia --setop="install_weak_deps=False" --exclude=PackageKit-gstreamer-plugin -y &&
        dnf groupupdate sound-and-video -y
      args:
        warn: false
      changed_when: true
  become: true
  when: ansible_distribution == "Fedora"

- name: Install base packages
  ansible.builtin.package:
    name: "{{ base_packages }}"
    state: present
  become: true

- name: Install 32bit packages, if multilib is enabled [Arch]
  ansible.builtin.pacman:
    name: "{{ multilib_packages }}"
    state: present
  register: installed_repo_packages
  when:
    - ansible_distribution == "Archlinux"
    - arch_enable_multilib | bool
    - multilib_packages is defined
  become: true

- name: AUR
  block:
    - name: Ensure the $HOME/AUR directory exists.
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/AUR"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"

    - name: Git clone AUR package(s) [Archlinux].
      ansible.builtin.git:
        repo: "https://aur.archlinux.org/{{ item }}"
        dest: "{{ ansible_user_dir }}/AUR/{{ item }}"
      loop: "{{ aur_packages | flatten(levels = 1) }}"

    - name: Install AUR packages [Archlinux].
      ansible.builtin.command:
        cmd: "makepkg -sirc --noconfirm"
        chdir: "{{ ansible_user_dir }}/AUR/{{ item }}"
      changed_when: false
      loop: "{{ aur_packages | flatten(levels = 1) }}"
  when:
    - ansible_distribution == "Archlinux"
    - aur_packages is defined

- name: Install packages with NPM
  community.general.npm:
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
    version: "{{ item.version | default(omit) }}"
    executable: "{{ item.executable | default(omit) }}"
    global: true
  loop: "{{ npm_packages }}"
  environment:
    npm_config_prefix: "{{ npm_config_prefix }}"
  when: npm_packages is defined

- name: Check if ~/.cargo is already present
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.cargo"
  register: cargo_dir

- name: Check if ~/.rustup is already present
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.cargo"
  register: rustup_dir

- name: Install Rust
  block:
    - name: Download the rustup installer.
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: /tmp/sh.rustup.rs
        mode: "755"
        force: true

    - name: Run the rustup script.
      ansible.builtin.command:
        cmd: /tmp/sh.rustup.rs -y --no-modify-path
      register: installer_output
      changed_when: "'stable-x86_64-unknown-linux-gnu installed' in installer_output.stdout"
  when: not cargo_dir.stat.exists and not rustup_dir.stat.exists

- name: Install packages with Cargo
  community.general.cargo:
    name: "{{ item.name }}"
    state: "{{ item.state | default('present') }}"
  loop: "{{ cargo_packages }}"
  when: cargo_packages is defined
  environment:
    PATH: "{{ ansible_user_dir }}/.cargo/bin"
